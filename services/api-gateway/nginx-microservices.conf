events {
    worker_connections 1024;
}

http {
    upstream auth-service {
        server auth-service:8000;
    }

    upstream user-service {
        server user-service:8000;
    }

    upstream targets-service {
        server targets-service:8000;
    }

    upstream jobs-service {
        server jobs-service:8000;
    }

    upstream execution-service {
        server execution-service:8000;
    }

    upstream audit-events-service {
        server audit-events-service:8000;
    }

    upstream notification-service {
        server notification-service:8000;
    }

    upstream target-discovery-service {
        server target-discovery-service:8000;
    }

    upstream job-scheduling-service {
        server job-scheduling-service:8000;
    }

    upstream job-management-service {
        server job-management-service:8000;
    }

    server {
        listen 80;
        server_name localhost;

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Auth Service
        location /api/v1/auth/ {
            proxy_pass http://auth-service/api/v1/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # User Service
        location /api/v1/users/ {
            proxy_pass http://user-service/api/v1/users/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/v1/roles/ {
            proxy_pass http://user-service/api/v1/roles/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/v1/permissions/ {
            proxy_pass http://user-service/api/v1/permissions/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/v1/profiles/ {
            proxy_pass http://user-service/api/v1/profiles/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Targets Service
        location /api/v1/targets/ {
            proxy_pass http://targets-service/api/v1/targets/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Target Discovery Service
        location /api/v1/target-discovery/ {
            proxy_pass http://target-discovery-service/api/v1/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Jobs Service
        location /api/v1/jobs/ {
            proxy_pass http://jobs-service/api/v1/jobs/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Job Management Service
        location /api/v1/job-management/ {
            proxy_pass http://job-management-service/api/v1/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Job Scheduling Service
        location /api/v1/job-scheduling/ {
            proxy_pass http://job-scheduling-service/api/v1/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Execution Service
        location /api/v1/executions/ {
            proxy_pass http://execution-service/api/v1/executions/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Audit Events Service
        location /api/v1/audit/ {
            proxy_pass http://audit-events-service/api/v1/audit/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Notification Service
        location /api/v1/notifications/ {
            proxy_pass http://notification-service/api/v1/notifications/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Default location for unmatched routes
        location / {
            return 404 "Endpoint not found";
            add_header Content-Type text/plain;
        }
    }
}